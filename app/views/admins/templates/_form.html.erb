<%= form_with(model: [:admins, template], local: true) do |form| %>

  <% if template.errors.any? %>
    <div style="color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
        <%= template.errors.full_messages.join(", ") %>
    </div>
  <% end %>

  <div class="input-group">
      <label class="input-label">Nome do template:</label>
      <%= form.text_field :titulo, class: "input-field-line", placeholder: "Ex: Avaliação 2024" %>
  </div>

  <div id="questions-container">
    <%= form.fields_for :questions do |q_form| %>
      <% next unless q_form.object %>
      <div class="question-block" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
        <%= q_form.hidden_field :id %>
        <%= q_form.hidden_field :_destroy, class: 'destroy-field' %>

        <div style="display: flex; justify-content: space-between;">
          <div class="question-title">Questão</div>
          <button type="button" class="btn-remove-question" style="background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">Excluir</button>
        </div>

        <div class="input-group">
            <label class="input-label">Tipo:</label>
            <%= q_form.select :question_type, [['Radio', 'radio'], ['Texto', 'text']], {}, { class: "custom-select" } %>
        </div>

        <div class="input-group">
            <label class="input-label">Enunciado:</label>
            <%= q_form.text_field :text, class: "input-field-line", placeholder: "Digite a pergunta..." %>
        </div>

        <div class="input-group">
            <label class="input-label">Opções (separadas por vírgula):</label>
            <%= q_form.text_field :options, value: (q_form.object.options.is_a?(Array) ? q_form.object.options.join(', ') : q_form.object.options), class: "input-field-line", placeholder: "Ex: Sim, Não, Talvez" %>
        </div>
      </div>
    <% end %>
  </div>

  <button type="button" id="add-question" class="btn-secondary" style="margin-top: 10px;">+ Adicionar Questão</button>
  <br><br>
  <%= form.submit "Salvar Template", class: "btn-create" %>

<% end %>

<template id="question-template">
    <div class="question-block" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
        <div style="display: flex; justify-content: space-between;">
          <div class="question-title">Nova Questão</div>
          <button type="button" class="btn-remove-new" onclick="this.closest('.question-block').remove()" style="background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">Excluir</button>
        </div>

        <div class="input-group">
            <label class="input-label">Tipo:</label>
            <select name="template[questions_attributes][__INDEX__][question_type]" class="custom-select">
                <option value="radio">Radio</option>
                <option value="text">Texto</option>
            </select>
        </div>

        <div class="input-group">
            <label class="input-label">Enunciado:</label>
            <input type="text" name="template[questions_attributes][__INDEX__][text]" class="input-field-line">
        </div>

        <div class="input-group">
            <label class="input-label">Opções (separadas por vírgula):</label>
            <input type="text" name="template[questions_attributes][__INDEX__][options]" class="input-field-line">
        </div>
    </div>
</template>

<script>
    document.addEventListener("turbo:load", initForm);
    document.addEventListener("DOMContentLoaded", initForm);

    function initForm() {
        const addBtn = document.getElementById("add-question");
        if(addBtn) {
            addBtn.onclick = function() {
                const container = document.getElementById("questions-container");
                const id = new Date().getTime();
                const html = document.getElementById("question-template").innerHTML.replace(/__INDEX__/g, id);
                container.insertAdjacentHTML('beforeend', html);
            };
        }

        // Lógica para esconder questões marcadas para exclusão (vindas do banco)
        document.querySelectorAll(".btn-remove-question").forEach(btn => {
            btn.onclick = function() {
                const block = this.closest(".question-block");
                block.querySelector(".destroy-field").value = "1";
                block.style.display = "none";
            }
        });
    }
</script>
